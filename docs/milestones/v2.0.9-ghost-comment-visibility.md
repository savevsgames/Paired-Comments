# Ghost Comment Visibility (v2.0.9)

**Status:** üìã PLANNED - User Priority Feature
**Estimate:** 2-3 days
**Priority:** HIGH - User explicitly requested
**Version:** v2.0.9

---

## üéØ Goal

Show paired comments directly in the source file as virtual/inline text (like Jupyter notebooks), without taking up actual lines. Users can toggle visibility of comments inline while keeping gutter icons and CodeLens.

---

## üìã Requirements

### Core Features

#### 1. Virtual Text Rendering
- **Use:** VS Code InlayHints API (preferred) or TextEditorDecorationType with `after` content
- **Appearance:**
  - Grey/dimmed text (non-editable)
  - Italic font style (configurable)
  - Opacity: 0.6 (configurable)
  - Appears above/before the commented line
  - Doesn't shift line numbers (virtual text only)

#### 2. Toggle Commands

**Three commands:**

1. **`pairedComments.toggleGhostView`** - `Ctrl+Alt+P G`
   - Toggle visibility for comment at current cursor line
   - If multiple comments on line, toggle all
   - Shows notification: "Ghost view enabled/disabled"

2. **`pairedComments.showAllGhosts`** - `Ctrl+Alt+P Ctrl+Alt+G`
   - Show all comments inline across current file
   - Update all comment decorations
   - Shows notification: "Showing all comments inline (X comments)"

3. **`pairedComments.hideAllGhosts`** - `Ctrl+Alt+P Ctrl+Alt+H`
   - Hide all inline comments
   - Keep gutter icons visible
   - Shows notification: "Hiding all inline comments"

#### 3. Settings

```json
{
  "pairedComments.ghostView.enabled": {
    "type": "boolean",
    "default": false,
    "description": "Show comments inline in editor (virtual text)"
  },
  "pairedComments.ghostView.maxLines": {
    "type": "number",
    "default": 5,
    "description": "Maximum lines to show for range comments"
  },
  "pairedComments.ghostView.opacity": {
    "type": "number",
    "default": 0.6,
    "minimum": 0.1,
    "maximum": 1.0,
    "description": "Opacity of ghost comment text (0.1 - 1.0)"
  },
  "pairedComments.ghostView.fontStyle": {
    "type": "string",
    "enum": ["italic", "normal"],
    "default": "italic",
    "description": "Font style for ghost comments"
  },
  "pairedComments.ghostView.showAuthor": {
    "type": "boolean",
    "default": true,
    "description": "Show author name in ghost comments"
  },
  "pairedComments.ghostView.showTag": {
    "type": "boolean",
    "default": true,
    "description": "Show tag (TODO, NOTE, etc.) in ghost comments"
  }
}
```

#### 4. Visual Format

**Single-line comment:**
```
// üë§ Greg | TODO: Refactor this function to use async/await
function processPayment(order) {
```

**Range comment (start line only):**
```
// üë§ Greg | TODO (lines 10-15): Complex logic needs refactoring...
function processData(items) {
  const filtered = items.filter(x => x > 0);
  const mapped = filtered.map(x => x * 2);
  return mapped.reduce((a, b) => a + b, 0);
}
```

**Truncation (if comment exceeds maxLines setting):**
```
// üë§ Greg | NOTE: This is a long comment that explains...
// ...and continues here... [Click to view full comment]
```

#### 5. Click Interaction
- Clicking ghost comment text opens paired view
- Focuses on clicked comment
- Uses existing `openPairedView()` command

---

## üõ†Ô∏è Implementation Plan

### Phase 1: InlayHints Provider (Day 1)

**File:** `src/ui/GhostCommentProvider.ts` (NEW)

```typescript
import * as vscode from 'vscode';
import { CommentManager } from '../core/CommentManager';
import { GhostMarkerManager } from '../core/GhostMarkerManager';

export class GhostCommentProvider implements vscode.InlayHintsProvider {
  private enabled: boolean = false;
  private enabledLines: Set<number> = new Set(); // Per-line toggle

  constructor(
    private commentManager: CommentManager,
    private ghostMarkerManager: GhostMarkerManager
  ) {}

  async provideInlayHints(
    document: vscode.TextDocument,
    range: vscode.Range,
    token: vscode.CancellationToken
  ): Promise<vscode.InlayHint[]> {
    if (!this.enabled && this.enabledLines.size === 0) {
      return [];
    }

    const hints: vscode.InlayHint[] = [];
    const comments = this.commentManager.getCommentsForFile(document.uri);

    for (const comment of comments) {
      const line = comment.line - 1; // Convert to 0-indexed

      // Check if within range and enabled
      if (line < range.start.line || line > range.end.line) continue;
      if (!this.enabled && !this.enabledLines.has(line)) continue;

      const hint = this.createInlayHint(comment, document);
      if (hint) hints.push(hint);
    }

    return hints;
  }

  private createInlayHint(
    comment: Comment,
    document: vscode.TextDocument
  ): vscode.InlayHint | null {
    const line = comment.line - 1;
    const position = new vscode.Position(line, 0);

    // Format comment text
    const text = this.formatGhostComment(comment);

    const hint = new vscode.InlayHint(
      position,
      text,
      vscode.InlayHintKind.Other
    );

    // Make it clickable - opens paired view
    hint.command = {
      title: 'Open Comment',
      command: 'pairedComments.open',
      arguments: [document.uri, comment.id]
    };

    return hint;
  }

  private formatGhostComment(comment: Comment): string {
    const config = vscode.workspace.getConfiguration('pairedComments.ghostView');
    const showAuthor = config.get<boolean>('showAuthor', true);
    const showTag = config.get<boolean>('showTag', true);
    const maxLines = config.get<number>('maxLines', 5);

    let parts: string[] = [];

    // Author
    if (showAuthor && comment.author) {
      parts.push(`üë§ ${comment.author}`);
    }

    // Tag
    if (showTag && comment.tag) {
      parts.push(comment.tag);
    }

    // Range indicator
    if (comment.endLine && comment.endLine > comment.line) {
      parts.push(`(lines ${comment.line}-${comment.endLine})`);
    }

    // Comment text (truncated)
    const textLines = comment.text.split('\n');
    const truncated = textLines.slice(0, maxLines).join(' ');
    const suffix = textLines.length > maxLines ? '... [Click to view full]' : '';

    parts.push(`${truncated}${suffix}`);

    return parts.join(' | ');
  }

  // Public control methods
  public enable() {
    this.enabled = true;
  }

  public disable() {
    this.enabled = false;
    this.enabledLines.clear();
  }

  public toggleLine(line: number) {
    if (this.enabledLines.has(line)) {
      this.enabledLines.delete(line);
    } else {
      this.enabledLines.add(line);
    }
  }

  public isEnabled(): boolean {
    return this.enabled || this.enabledLines.size > 0;
  }
}
```

### Phase 2: Register Provider (Day 1)

**File:** `src/extension.ts` (MODIFY)

```typescript
import { GhostCommentProvider } from './ui/GhostCommentProvider';

let ghostCommentProvider: GhostCommentProvider;

export function activate(context: vscode.ExtensionContext) {
  // ... existing code ...

  // Register ghost comment provider
  ghostCommentProvider = new GhostCommentProvider(
    commentManager,
    ghostMarkerManager
  );

  context.subscriptions.push(
    vscode.languages.registerInlayHintsProvider(
      { pattern: '**/*' }, // All files
      ghostCommentProvider
    )
  );

  // ... existing code ...
}
```

### Phase 3: Toggle Commands (Day 2)

**File:** `src/commands/index.ts` (MODIFY)

```typescript
// Toggle ghost view for current line
context.subscriptions.push(
  vscode.commands.registerCommand('pairedComments.toggleGhostView', async () => {
    const editor = vscode.window.activeTextEditor;
    if (!editor) return;

    const line = editor.selection.active.line;
    ghostCommentProvider.toggleLine(line);

    // Refresh inlay hints
    vscode.commands.executeCommand('editor.action.inlayHints.refresh');

    vscode.window.showInformationMessage(
      `Ghost view ${ghostCommentProvider.isEnabled() ? 'enabled' : 'disabled'} for line ${line + 1}`
    );
  })
);

// Show all ghosts
context.subscriptions.push(
  vscode.commands.registerCommand('pairedComments.showAllGhosts', async () => {
    ghostCommentProvider.enable();
    vscode.commands.executeCommand('editor.action.inlayHints.refresh');

    const editor = vscode.window.activeTextEditor;
    if (editor) {
      const comments = commentManager.getCommentsForFile(editor.document.uri);
      vscode.window.showInformationMessage(
        `Showing all comments inline (${comments.length} comments)`
      );
    }
  })
);

// Hide all ghosts
context.subscriptions.push(
  vscode.commands.registerCommand('pairedComments.hideAllGhosts', async () => {
    ghostCommentProvider.disable();
    vscode.commands.executeCommand('editor.action.inlayHints.refresh');

    vscode.window.showInformationMessage('Hiding all inline comments');
  })
);
```

### Phase 4: Package.json Updates (Day 2)

**File:** `package.json` (MODIFY)

Add commands:
```json
{
  "command": "pairedComments.toggleGhostView",
  "title": "Toggle Ghost View (Current Line)",
  "category": "Paired Comments"
},
{
  "command": "pairedComments.showAllGhosts",
  "title": "Show All Comments Inline",
  "category": "Paired Comments"
},
{
  "command": "pairedComments.hideAllGhosts",
  "title": "Hide All Inline Comments",
  "category": "Paired Comments"
}
```

Add keybindings:
```json
{
  "command": "pairedComments.toggleGhostView",
  "key": "ctrl+alt+p g",
  "when": "editorTextFocus"
},
{
  "command": "pairedComments.showAllGhosts",
  "key": "ctrl+alt+p ctrl+alt+g",
  "when": "editorTextFocus"
},
{
  "command": "pairedComments.hideAllGhosts",
  "key": "ctrl+alt+p ctrl+alt+h",
  "when": "editorTextFocus"
}
```

Add configuration:
```json
"pairedComments.ghostView.enabled": { ... },
"pairedComments.ghostView.maxLines": { ... },
"pairedComments.ghostView.opacity": { ... },
"pairedComments.ghostView.fontStyle": { ... },
"pairedComments.ghostView.showAuthor": { ... },
"pairedComments.ghostView.showTag": { ... }
```

### Phase 5: Menu Integration (Day 2)

**File:** `src/commands/index.ts` (MODIFY)

Update command menu to include new commands:
```typescript
const commandDescriptions = [
  // ... existing commands ...
  {
    label: '$(eye) Toggle Ghost View',
    description: 'Show/hide comment at current line inline',
    detail: 'Toggle inline comment visibility',
    key: 'G',
    command: 'pairedComments.toggleGhostView'
  },
  {
    label: '$(eye) Show All Ghosts',
    description: 'Show all comments inline',
    detail: 'Display all comments as virtual text',
    key: '',
    command: 'pairedComments.showAllGhosts'
  },
  {
    label: '$(eye-closed) Hide All Ghosts',
    description: 'Hide all inline comments',
    detail: 'Hide virtual text, keep gutter icons',
    key: '',
    command: 'pairedComments.hideAllGhosts'
  }
];
```

### Phase 6: Testing & Polish (Day 3)

**Manual Testing:**
1. Create comments with different tags (TODO, NOTE, FIXME)
2. Test toggle for single line
3. Test show all / hide all
4. Test with range comments
5. Test long comments (truncation)
6. Test click to open
7. Test settings (opacity, font style, max lines)

**Configuration Testing:**
- Change opacity - verify visual update
- Change font style - verify italic/normal
- Change maxLines - verify truncation
- Toggle showAuthor/showTag - verify format

**Edge Cases:**
- Empty comments
- Very long comments (> 1000 chars)
- Multiple comments on same line
- Range comments spanning many lines
- Comments with special characters
- Unicode in comment text

---

## ‚úÖ Success Criteria

1. ‚úÖ Ghost comments appear inline without shifting line numbers
2. ‚úÖ Toggle commands work for single line and all comments
3. ‚úÖ Click on ghost comment opens paired view
4. ‚úÖ Settings control appearance (opacity, font, truncation)
5. ‚úÖ Performance: <50ms to render 100 ghost comments
6. ‚úÖ Visual quality: Text is readable but clearly non-source
7. ‚úÖ Keyboard shortcuts work: Ctrl+Alt+P G, Ctrl+Alt+P Ctrl+Alt+G, Ctrl+Alt+P Ctrl+Alt+H

---

## üìä Estimated Effort

| Task | Time | Notes |
|------|------|-------|
| InlayHints Provider | 4 hours | Core implementation |
| Toggle Commands | 2 hours | Three commands + state management |
| Package.json Updates | 1 hour | Commands, keybindings, settings |
| Menu Integration | 1 hour | Update command menu |
| Testing & Polish | 4 hours | Manual testing + edge cases |
| **Total** | **12 hours** | **~2 working days** |

---

## üîó Dependencies

- ‚úÖ CommentManager - Already implemented
- ‚úÖ GhostMarkerManager - Already implemented
- ‚úÖ DecorationManager - Already implemented (gutter icons)
- ‚úÖ VS Code InlayHints API - Built-in (VS Code 1.60+)

**No blockers - can implement immediately!**

---

## üìù Notes

### Why InlayHints vs Decorations?

**InlayHints (Chosen):**
- ‚úÖ Designed for virtual text (not actual lines)
- ‚úÖ Doesn't shift line numbers
- ‚úÖ Better performance for many hints
- ‚úÖ Built-in click support
- ‚úÖ VS Code handles positioning

**Decorations (Alternative):**
- ‚ùå Requires `before` or `after` content
- ‚ùå Less control over positioning
- ‚ùå More complex click handling

### Future Enhancements (Post-v2.0.9)
- **v2.1:** Syntax highlighting for comment text
- **v2.2:** Inline editing (click to edit)
- **v2.3:** Ghost comment animations (fade in/out)
- **v2.4:** Customizable ghost comment templates

---

## üöÄ Ready to Implement

All design decisions made. Implementation can start immediately after user confirmation.
