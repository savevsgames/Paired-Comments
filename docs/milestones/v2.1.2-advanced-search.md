# Milestone: Advanced Search & Filtering (v2.1.2)

**Target Release:** November 2025 (2-3 weeks)
**Priority:** High
**Estimated Effort:** 3-4 days
**Dependencies:** Phase 2 complete (AI Metadata)

---

## 📋 Overview

Add powerful search and filtering capabilities to help users find comments quickly in large codebases. Currently, users can only browse comments linearly - this milestone adds Google-like search with filters, making it easy to find specific comments across hundreds or thousands of comments.

---

## 🎯 Goals

### Primary
- Multi-field search across comment text, author, tags, symbols, and dates
- Quick filters for common queries (TODO only, my comments, orphaned, AI-enriched)
- Search results view with grouping and navigation
- Export search results to Markdown

### Secondary
- Search persistence (save recent searches)
- Search history
- Regex support for advanced users
- Keyboard shortcuts for quick search

---

## ✨ Features

### 1. Multi-Field Search Engine

**Search Fields:**
- **Text Content** - Full-text search in comment body (supports partial match)
- **Author** - Filter by comment author name
- **Tag** - Filter by TODO, FIXME, NOTE, QUESTION, HACK, WARNING, STAR
- **Symbol** - Search by function/class/variable name (from AST anchor)
- **Status** - Filter by open, resolved, wontfix
- **Date Range** - Created/updated between dates
- **AI Metadata** - Has complexity score, token estimate, or parameter extraction

**Search Syntax:**
```
Basic:          "refactoring"
Author:         author:john
Tag:            tag:TODO
Symbol:         symbol:calculateTotal
Multiple:       "refactoring" tag:TODO author:john
Date:           created:>2025-10-01
AI-enriched:    has:complexity
Orphaned:       is:orphaned
Resolved:       is:resolved
```

**Implementation:**
```typescript
// src/features/CommentSearchEngine.ts
export interface SearchQuery {
  text?: string;           // Free text search
  author?: string;         // Exact or partial match
  tags?: CommentTag[];     // Array of tags to match
  symbol?: string;         // Symbol name (partial match)
  status?: CommentStatus[]; // Array of statuses
  createdAfter?: Date;
  createdBefore?: Date;
  updatedAfter?: Date;
  updatedBefore?: Date;
  hasAIMetadata?: boolean;
  hasComplexity?: boolean;
  hasTokens?: boolean;
  hasParameters?: boolean;
  isOrphaned?: boolean;
}

export class CommentSearchEngine {
  /**
   * Search across all loaded comment files
   */
  async search(query: SearchQuery): Promise<SearchResult[]> {
    // Load all .comments files in workspace
    // Filter by query criteria
    // Return sorted results
  }

  /**
   * Parse search string into SearchQuery
   * Example: "refactoring tag:TODO author:john" → { text: "refactoring", tags: ["TODO"], author: "john" }
   */
  parseSearchString(searchString: string): SearchQuery {
    // Parse field:value syntax
    // Extract plain text
    // Return structured query
  }
}

export interface SearchResult {
  comment: Comment;
  sourceFile: string;
  matchScore: number;        // Relevance score (0-100)
  matchedFields: string[];   // Which fields matched
  context?: string;          // Snippet with highlighted match
}
```

---

### 2. Quick Filters

**Filter Buttons in Search UI:**
```
[✓ TODO]  [✓ FIXME]  [ NOTE]  [ My Comments]  [ Orphaned]  [ AI-Enriched]
```

**Predefined Filters:**
- **All TODOs** - `tag:TODO`
- **All FIXMEs** - `tag:FIXME`
- **My Comments** - `author:{current user}`
- **Orphaned Markers** - `is:orphaned`
- **AI-Enriched** - `has:complexity OR has:tokens OR has:parameters`
- **Unresolved** - `status:open`
- **Recent (7 days)** - `created:>7d`
- **High Complexity** - `complexity:>10`

**Implementation:**
```typescript
export const QUICK_FILTERS: Record<string, SearchQuery> = {
  todos: { tags: ['TODO'], status: ['open'] },
  fixmes: { tags: ['FIXME'], status: ['open'] },
  myComments: { author: '{current_user}' },  // Replaced at runtime
  orphaned: { isOrphaned: true },
  aiEnriched: { hasAIMetadata: true },
  recent: { createdAfter: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) },
};
```

---

### 3. Search Results View

**UI Components:**

**Search Panel** (VS Code Webview or TreeView):
```
┌─────────────────────────────────────────────┐
│ 🔍 Search Comments                          │
├─────────────────────────────────────────────┤
│ [Search text or use field:value syntax   ] │
│                                             │
│ Quick Filters:                              │
│ [TODO] [FIXME] [My Comments] [Orphaned]     │
│                                             │
│ Results: 42 comments in 8 files             │
│ Group by: [File ▼]  Sort: [Relevance ▼]    │
├─────────────────────────────────────────────┤
│ 📁 src/core/CommentManager.ts (12)          │
│   ⚠️ TODO: Refactor this method (john)      │
│      Line 145 • Created Oct 15 • 2 days ago │
│   🔥 FIXME: Handle edge case (jane)         │
│      Line 203 • Created Oct 10 • 1 week ago │
│                                             │
│ 📁 src/io/FileSystemManager.ts (8)          │
│   📌 NOTE: This needs optimization (john)   │
│      Line 67 • Created Sep 30 • 3 weeks ago │
│                                             │
│ [Export to Markdown]  [Clear]               │
└─────────────────────────────────────────────┘
```

**Grouping Options:**
- Group by File
- Group by Author
- Group by Tag
- Group by Date (Today, This Week, This Month, Older)
- Group by Symbol (function/class name)

**Sorting Options:**
- Relevance (match score)
- Date Created (newest first)
- Date Updated (most recently edited)
- Line Number (file order)
- Alphabetical (by text)

**Click Actions:**
- Click comment → Opens paired view and navigates to line
- Right-click → Context menu (Edit, Delete, Change Tag, Copy)
- Hover → Shows full comment text + AI metadata preview

---

### 4. Export Search Results

**Export Formats:**

**Markdown Export:**
```markdown
# Search Results: "refactoring"
*Generated: 2025-10-19 01:23 PM*
*42 comments across 8 files*

## src/core/CommentManager.ts
### TODO: Refactor this method (line 145)
**Author:** john
**Created:** 2025-10-15
**Symbol:** `updateComment`

The updateComment method has too many responsibilities...

### FIXME: Handle edge case (line 203)
**Author:** jane
**Created:** 2025-10-10

...
```

**JSON Export** (for tooling):
```json
{
  "query": "refactoring tag:TODO",
  "results": [
    {
      "file": "src/core/CommentManager.ts",
      "line": 145,
      "comment": {
        "text": "TODO: Refactor this method",
        "author": "john",
        "created": "2025-10-15T10:30:00Z",
        "tag": "TODO"
      }
    }
  ],
  "totalResults": 42,
  "filesSearched": 8
}
```

**CSV Export** (for spreadsheets):
```csv
File,Line,Tag,Author,Created,Text
src/core/CommentManager.ts,145,TODO,john,2025-10-15,"Refactor this method"
```

---

## 🛠️ Implementation Plan

### Phase 1: Search Engine (Day 1-2)
- [x] Create `src/features/CommentSearchEngine.ts`
- [x] Implement `SearchQuery` interface
- [x] Implement `parseSearchString()` - parse "field:value" syntax
- [x] Implement `search()` - iterate all .comments files and filter
- [x] Add relevance scoring (text match = 100, tag match = 80, author match = 60, etc.)
- [x] Add tests: `test/unit/CommentSearchEngine.test.ts`

### Phase 2: Search UI (Day 2-3)
- [x] Create `src/ui/SearchPanel.ts` (Webview or TreeDataProvider)
- [x] Add search input with autocomplete for field names
- [x] Add quick filter buttons
- [x] Add grouping dropdown
- [x] Add sorting dropdown
- [x] Wire up click handlers → navigate to comment
- [x] Add keyboard shortcuts (Ctrl+Shift+F for search)

### Phase 3: Export & Polish (Day 3-4)
- [x] Implement Markdown export
- [x] Implement JSON export (optional)
- [x] Implement CSV export (optional)
- [x] Add search history (recent searches dropdown)
- [x] Add "Save Search" feature (bookmark common queries)
- [x] Add loading indicators for large workspaces
- [x] Performance optimization (index comments for faster search)

---

## 🧪 Testing Strategy

### Unit Tests
```typescript
// test/unit/CommentSearchEngine.test.ts
describe('CommentSearchEngine', () => {
  it('should parse simple text query', () => {
    const query = engine.parseSearchString('refactoring');
    expect(query.text).to.equal('refactoring');
  });

  it('should parse field:value syntax', () => {
    const query = engine.parseSearchString('tag:TODO author:john');
    expect(query.tags).to.deep.equal(['TODO']);
    expect(query.author).to.equal('john');
  });

  it('should search by text content', () => {
    const results = engine.search({ text: 'refactoring' });
    expect(results).to.have.lengthOf(3);
  });

  it('should filter by tag', () => {
    const results = engine.search({ tags: ['TODO'] });
    expect(results.every(r => r.comment.tag === 'TODO')).to.be.true;
  });

  it('should combine multiple criteria', () => {
    const results = engine.search({
      text: 'refactoring',
      tags: ['TODO'],
      author: 'john'
    });
    expect(results).to.have.lengthOf(1);
  });
});
```

### Integration Tests
```typescript
// test/integration/SearchWorkflow.test.ts
it('should search across multiple files', () => {
  // Create 3 files with comments
  // Search for text appearing in 2 files
  // Verify results include both files
});

it('should export search results to Markdown', () => {
  // Perform search
  // Export results
  // Verify Markdown format
});
```

### Manual Testing
- [ ] Search with plain text works
- [ ] Search with "tag:TODO" works
- [ ] Quick filters toggle correctly
- [ ] Grouping changes display
- [ ] Sorting changes order
- [ ] Click navigation works
- [ ] Export to Markdown works
- [ ] Performance acceptable (< 1s for 1000 comments)

---

## 📊 Success Metrics

- [ ] Search returns results in < 1 second for 1000 comments
- [ ] All search fields functional (text, author, tag, symbol, date, AI)
- [ ] Quick filters work with single click
- [ ] Export generates valid Markdown
- [ ] Search panel accessible via keyboard (Ctrl+Shift+F)
- [ ] User can save and reuse common searches

---

## 🔗 Dependencies

**Required:**
- Phase 2 complete (need AI metadata for has:complexity filter)
- CommentManager.getAllComments() - load all comments in workspace

**Optional (Future):**
- Search indexing for performance (v2.2+)
- Semantic search with AI embeddings (v2.3+)

---

## 📝 Documentation Needs

- [ ] Add search syntax guide to README
- [ ] Add examples of common searches
- [ ] Document quick filters
- [ ] Add GIF demo of search in action
- [ ] Update CHANGELOG.md

---

## 🚀 Future Enhancements (v2.2+)

- **Regex Support:** `text:/function \w+/`
- **Search History:** Recent searches dropdown
- **Saved Searches:** Bookmark common queries
- **Search Indexing:** Pre-index comments for instant search
- **Semantic Search:** AI-powered "find similar comments"
- **Search API:** Expose search via MCP for AI agents
- **Search Stats:** "You have 42 TODOs, 18 FIXMEs"

---

**Status:** Design complete, ready for implementation
**Next Step:** Create `src/features/CommentSearchEngine.ts` and begin Phase 1
